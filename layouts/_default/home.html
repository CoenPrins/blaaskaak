{{ define "content" }}
{{ .Content }}

<div class="list-container">
  <ul id="events" class="scale-up-hover-list"></ul>

  <template id="event-template">
    <li>
      <div class="event-date">
        <p class="event-day"></p>
        <p class="event-month"></p>
      </div>
      <div class="event-details">
        <h1 class="event-title"></h1>
        <p class="event-location">
          <a href="" target="_blank" rel="noopener"></a>
        </p>
        <p class="event-description"></p>
      </div>
    </li>
  </template>
</div>

<script type="module">
  const url = '/events.ics'
  import ICAL from '/js/ical.min.js'

  async function loadEvents() {
    const res = await fetch(url)
    const text = await res.text()
    const jcal = ICAL.parse(text)
    const comp = new ICAL.Component(jcal)
    const now = new Date()
    const events = comp
      .getAllSubcomponents('vevent')
      .map(v => new ICAL.Event(v))
      // .filter(e => {
      //   const d = e.startDate.toJSDate()
      //   return d >= new Date(now.getFullYear(), now.getMonth(), now.getDate())
      // })
      .sort((a, b) => a.startDate.toJSDate() - b.startDate.toJSDate())

    const list = document.querySelector('#events')
    const template = document.querySelector('#event-template')

    for (const event of events) {
      const clone = template.content.cloneNode(true)
      const date = event.startDate.toJSDate()
      const monthday = date.getDate()
      const monthname = date.toLocaleString('nl-NL', { month: 'short' })

      clone.querySelector('.event-day').textContent = monthday
      clone.querySelector('.event-month').textContent = monthname
      clone.querySelector('.event-title').textContent = event.summary

      const locationLink = clone.querySelector('.event-location a')
      locationLink.textContent = event.location
      locationLink.href = `https://www.google.nl/maps/place/${encodeURIComponent(event.location)}`

      list.appendChild(clone)
    }
  }

  loadEvents()
</script>

{{ end }}
